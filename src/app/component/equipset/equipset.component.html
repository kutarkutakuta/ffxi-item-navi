<nz-space>
  <nz-select [(ngModel)]="selectedJob" nzSize="default" style="width: 90px;" nzPlaceHolder="ジョブ"
    *nzSpaceItem (ngModelChange)="redo()">
    <nz-option *ngFor="let option of jobs" [nzLabel]="option" [nzValue]="option"></nz-option>
  </nz-select>
  <button nz-button nzType="primary" *nzSpaceItem (click)="redo()" [disabled]="!selectedJob">
    <span nz-icon nzType="reload" nzTheme="outline"></span>Reload
  </button>
  <button nz-button nzType="primary" *nzSpaceItem (click)="save()" [disabled]="!selectedJob">
    <span nz-icon nzType="check" nzTheme="outline"></span>Save
  </button>
  <div *nzSpaceItem [hidden]="!(equipsetgroup | async )?.updated" style="padding-top: 10px; padding-left: 5px;">
    Saved: {{(equipsetgroup | async )?.updated | date: 'yy/MM/dd HH:mm:ss' }}
  </div>
</nz-space>

<nz-tabset *ngIf="selectedJob"
  [(nzSelectedIndex)]="selectedEquipsetTabIndex"
  nzType="editable-card"
  (nzAdd)="newTab(this.selectedJob)"
  (nzClose)="closeTab($event.index)"
>
  <nz-tab *ngFor="let equipset of (equipsetgroup | async )?.equipsets;let i = index" nzClosable [nzTitle]="equipset.name">
    <ng-template nz-tab>
      <div nz-row nzJustify="space-between">
        <div nz-col nzSpan="16">
            <input nz-input placeholder="タイトル" [(ngModel)]="equipset.name" style="width: 150px;" maxlength="10" />
            <button nz-button nzType="primary" (click)="copy(this.selectedJob, equipset)">Copy</button>
            <textarea  nz-input placeholder="メモ" [(ngModel)]="equipset.memo" style="width: 400px;" maxlength="100" nzAutosize></textarea>
        </div>
        <div nz-col nzSpan="8" align="right" style="margin-top: -12px;" >
          <nz-space>
            <input nz-input placeholder="公開ﾕｰｻﾞ名" [(ngModel)]="equipset.publish_user" style="width: 95px;" maxlength="10" />
            <button nz-button nzType="primary" nzDanger *nzSpaceItem (click)="publish(equipset)">
              <span nz-icon nzType="cloud-upload"></span>公開する
            </button>
          </nz-space>
          <div >
            {{equipset.publish_id ? 'Published ID [' + equipset.publish_id + ']: ' + (equipset.publish_date | date:'yy/MM/dd HH:mm:ss') : ''}}
          </div>
        </div>
      </div>

      <!-- 装備セット一覧 -->
      <nz-table #equipsetTable [nzData]="equipset.equip_items"
        nzShowPagination="false" class="equipset-table"  [nzPageSize]="20"
        [nzScroll]="{x: '100%'}">
        <thead>
          <tr>
            <th nzLeft nzWidth="60px">Slot</th>
            <th nzWidth="110px">Type</th>
            <th nzWidth="322px">
              Equip
              <span nz-icon nzType="question-circle" nzTheme="outline"
              nz-tooltip nzTooltipTitle="装備名はクエリ検索も可能です。(例)DEX>10"></span>
            </th>
            <th nzWidth="18px"></th>
            <th nzWidth="280px">
              PC Augment
              <span nz-icon nzType="question-circle" nzTheme="outline"
              nz-tooltip nzTooltipTitle="スペース区切りでオグメを指定します。(例)攻:20 命中:50"></span>
            </th>
            <th nzWidth="18px"></th>
            <th nzWidth="220px">
              PET Augment
              <span nz-icon nzType="question-circle" nzTheme="outline"
              nz-tooltip nzTooltipTitle="スペース区切りでオグメを指定します。(例)攻:20 命中:50"></span>
            </th>
            <th nzWidth="18px"></th>
            <th nzWidth="280px">Memo</th>
            <th style="background-color: transparent ;border:none;"></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let equipitem of equipsetTable.data">
            <th nzLeft class="slot-cell">{{ equipitem.slot }}</th>
            <td>
              <nz-select *ngIf="equipitem.slot=='メイン' || equipitem.slot=='サブ' || equipitem.slot=='レンジ' || equipitem.slot=='矢弾'"
              [(ngModel)]="equipitem.type" nzSize="default" style="width: 100%;" nzSize="small" nzAllowClear
              (ngModelChange)="equipitem.equipment = null" nzPlaceHolder="武器種">
                <nz-option *ngFor="let option of slot_types[equipitem.slot]" [nzLabel]="option" [nzValue]="option"></nz-option>
              </nz-select>
            </td>
            <td>
              <nz-select *ngIf="!(equipitem.slot=='メイン' || equipitem.slot=='サブ' || equipitem.slot=='レンジ' || equipitem.slot=='矢弾') || equipitem.type"
                nzShowSearch nzServerSearch nzPlaceHolder="装備名"
                [(ngModel)]="equipitem.equipment" [nzFilterOption]="nzFilterOption"
                (nzOnSearch)="searchEquipment($event, equipitem)" (nzFocus)="searchEquipment('', equipitem)"
                style="width: 180px;" nzSize="small" nzAllowClear (ngModelChange)="changeEquipment(equipitem)">
                <nz-option *ngFor="let o of equipments" [nzLabel]="o.name" [nzValue]="o"></nz-option>
                <nz-option [nzLabel]="equipitem.equipment?.name!" [nzValue]="equipitem.equipment" nzHide></nz-option>
              </nz-select>
              <nz-select *ngIf="equipitem.equipment?.equipment_augs?.length!>0"
                nzShowSearch nzServerSearch nzPlaceHolder="オグメ名称"
                [(ngModel)]="equipitem.equipment_aug" [nzFilterOption]="nzFilterOption"
                style="width: 140px;" nzSize="small"
                nzAllowClear (ngModelChange)="changeAugName(equipitem)">
                <nz-option *ngFor="let o of equipitem.equipment?.equipment_augs" [nzLabel]="getAugName(o)" [nzValue]="o"></nz-option>
                <nz-option [nzLabel]="getAugName(equipitem.equipment_aug!)" [nzValue]="equipitem.equipment_aug" nzHide></nz-option>
              </nz-select>
            </td>
            <td style="text-align: center;">
              <a *ngIf="equipitem.equipment" (click)="showItemDetail(equipitem.equipment, equipitem.equipment_aug!)">
                <span nz-icon nzType="info-circle" nzTheme="outline"></span>
              </a>
            </td>
            <td>
              <textarea nz-input placeholder="オーグメント" [(ngModel)]="equipitem.custom_pc_aug" (ngModelChange)="changeAugText(equipitem)"
              nzSize="small" style="min-height:24px !important;height:24px !important;"></textarea>
            </td>
            <td style="text-align: center;">
              <span *ngIf="equipitem.custom_pc_aug_error" nz-tooltip nz-tooltip [nzTooltipTitle]="'[無効] ' + equipitem.custom_pc_aug_error"
                nzTooltipColor="orange" nz-icon [nzType]="'warning'" [nzTheme]="'twotone'" [nzTwotoneColor]="'orange'"></span>
            </td>
            <td>
              <textarea nz-input placeholder="オーグメント" [(ngModel)]="equipitem.custom_pet_aug" (ngModelChange)="changeAugText(equipitem)"
              nzSize="small" style="min-height:24px !important;height:24px !important;"></textarea>
            </td>

            <td style="text-align: center;">
              <span *ngIf="equipitem.custom_pet_aug_error" nz-tooltip nz-tooltip [nzTooltipTitle]="'[無効] ' + equipitem.custom_pet_aug_error"
                nzTooltipColor="orange" nz-icon [nzType]="'warning'" [nzTheme]="'twotone'" [nzTwotoneColor]="'orange'"></span>
            </td>
            <td>
              <input nz-input placeholder="メモ" [(ngModel)]="equipitem.memo" nzAllowClear nzSize="small" />
            </td>
          </tr>
        </tbody>
      </nz-table>

      <br/>

      <!-- ステータス一覧 -->
      <div style="display: flex;overflow-x: auto;">
        <nz-tabset  nzTabPosition="left" style="min-width: 1200px;">
          <nz-tab n nzTitle="物理">
              <table class="status-table">
                <tr>
                  <th *ngFor="let status of getStauses('BASE')">{{status.short_name}}</th>
                </tr>
                <tr>
                  <td *ngFor="let status of getStauses('BASE')">
                    {{ getStausValue(equipset, status.name) }}
                  </td>
                </tr>
              </table>

              <table class="status-table">
                <tr>
                  <th *ngFor="let data of getStauses('ATACK')">{{data.short_name}}</th>
                </tr>
                <tr>
                  <td *ngFor="let data of getStauses('ATACK')">
                    {{ getStausValue(equipset, data.name) }}
                  </td>
                </tr>
              </table>

              <table class="status-table">
                <tr>
                  <th *ngFor="let data of getStauses('DEFENSE')">{{data.short_name}}</th>
                </tr>
                <tr>
                  <td *ngFor="let data of getStauses('DEFENSE')">
                    {{ getStausValue(equipset, data.name) }}
                  </td>
                </tr>
              </table>
          </nz-tab>
          <nz-tab n nzTitle="魔法">
            <table class="status-table">
              <tr>
                <th *ngFor="let data of getStauses('BASE')">{{data.short_name}}</th>
              </tr>
              <tr>
                <td *ngFor="let data of getStauses('BASE')">
                  {{ getStausValue(equipset, data.name) }}
                </td>
              </tr>
            </table>

            <table class="status-table">
              <tr>
                <th *ngFor="let data of getStauses('MAGIC')">{{data.short_name}}</th>
              </tr>
              <tr>
                <td *ngFor="let data of getStauses('MAGIC')">
                  {{ getStausValue(equipset, data.name) }}
                </td>
              </tr>
            </table>

            <table class="status-table">
              <tr>
                <th *ngFor="let data of getStauses('MAGIC-SKILL')">{{data.short_name}}</th>
              </tr>
              <tr>
                <td *ngFor="let data of getStauses('MAGIC-SKILL')">
                  {{ getStausValue(equipset, data.name) }}
                </td>
              </tr>
            </table>

          </nz-tab>
        </nz-tabset>
      </div>

      <br/>

      <!-- 比較 -->
      <span style="font-weight: bolder;padding-right: 5px;">比較</span>
      <nz-select nzShowSearch nzServerSearch nzPlaceHolder="比較対象"
        [nzFilterOption]="nzFilterOption" style="width: 250px;" nzAllowClear
        [(ngModel)]="equipset.compareEquipset">
        <ng-container  *ngFor="let o of (equipsetgroup | async)?.equipsets">
          <nz-option *ngIf="o != equipset" [nzLabel]="o.name" [nzValue]="o"></nz-option>
          <nz-option [nzLabel]="equipset.compareEquipset?.name!" [nzValue]="equipset.compareEquipset" nzHide></nz-option>
        </ng-container>
      </nz-select>

      <div style="display: flex;overflow-x: auto;">
        <nz-tabset *ngIf="equipset.compareEquipset" nzTabPosition="left" style="min-width: 1200px;">
          <nz-tab n nzTitle="物理">
            <table class="status-table">
              <tr>
                <th *ngFor="let status of getStauses('BASE')">{{status.short_name}}</th>
              </tr>
              <tr>
                <td *ngFor="let status of getStauses('BASE')">
                  <div [innerHTML]='getStausValue2(equipset, status.name)'></div>
                </td>
              </tr>
            </table>

            <table class="status-table">
              <tr>
                <th *ngFor="let status of getStauses('ATACK')">{{status.short_name}}</th>
              </tr>
              <tr>
                <td *ngFor="let status of getStauses('ATACK')">
                  <div [innerHTML]='getStausValue2(equipset, status.name)'></div>
                </td>
              </tr>
            </table>

            <table class="status-table">
              <tr>
                <th *ngFor="let status of getStauses('DEFENSE')">{{status.short_name}}</th>
              </tr>
              <tr>
                <td *ngFor="let status of getStauses('DEFENSE')">
                  <div [innerHTML]='getStausValue2(equipset, status.name)'></div>
                </td>
              </tr>
            </table>
          </nz-tab>
          <nz-tab n nzTitle="魔法">
            <table class="status-table">
              <tr>
                <th *ngFor="let status of getStauses('BASE')">{{status.short_name}}</th>
              </tr>
              <tr>
                <td *ngFor="let status of getStauses('BASE')">
                  <div [innerHTML]='getStausValue2(equipset, status.name)'></div>
                </td>
              </tr>
            </table>

            <table class="status-table">
              <tr>
                <th *ngFor="let status of getStauses('MAGIC')">{{status.short_name}}</th>
              </tr>
              <tr>
                <td *ngFor="let status of getStauses('MAGIC')">
                  <div [innerHTML]='getStausValue2(equipset, status.name)'></div>
                </td>
              </tr>
            </table>

            <table class="status-table">
              <tr>
                <th *ngFor="let status of getStauses('MAGIC-SKILL')">{{status.short_name}}</th>
              </tr>
              <tr>
                <td *ngFor="let status of getStauses('MAGIC-SKILL')">
                  <div [innerHTML]='getStausValue2(equipset, status.name)'></div>
                </td>
              </tr>
            </table>

          </nz-tab>
        </nz-tabset>
      </div>
    </ng-template>
  </nz-tab>
</nz-tabset>
<app-item-detail #ItemDetail></app-item-detail>




